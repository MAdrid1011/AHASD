# AHASD Simulator **Platform**

This document describes how to use the AHASD simulator platform to reproduce the experimental results from the paper.

## Architecture Overview

The AHASD simulator platform integrates two open-source cycle-accurate simulators:

1. **ONNXim** - For simulating mobile NPU
2. **PIMSimulator (SAIT)** - For simulating LPDDR5-PIM

We have implemented the following AHASD key components on top of these two simulators:

### Core Components

#### 1. Asynchronous Queue System (`ONNXim/src/async_queue/AsyncQueue.h`)
- **Unverified Draft Queue**: Stores token batches generated by PIM awaiting verification
- **Feedback Queue**: Stores TLM verification results
- **Pre-verification Queue**: Marks drafts requiring pre-verification within PIM

#### 2. EDC Module (`ONNXim/src/async_queue/EDC.h`)
**Entropy-History-Aware Drafting Control**
- Local Entropy History Table (LEHT): 8 entries
- Local Commit Entropy History Table (LCEHT): 8 entries
- Leading Length Register (LLR): 3-bit counter
- Pattern History Table (PHT): 512 entries, 2-bit saturating counters

**Hardware Overhead**:
- LEHT: 8 × 3 bits = 24 bits
- LCEHT: 8 × 3 bits = 24 bits
- LLR: 3 bits
- PHT: 512 × 2 bits = 1024 bits
- **Total**: ~1075 bits ≈ 135 bytes

#### 3. TVC Module (`ONNXim/src/async_queue/TVC.h`)
**Time-Aware Pre-Verification Control**
- NPU Verification Cycle Table (NVCT): 4 entries
- PIM Drafting Cycle Table (PDCT): 4 entries
- PIM Pre-Verification Cycle Table (PVCT): 4 entries
- NPU Current Execution Cycle Register (NCR): 64 bits

**Hardware Overhead**:
- NVCT: 4 × (64 + 32) bits = 384 bits
- PDCT: 4 × (64 + 32) bits = 384 bits
- PVCT: 4 × (64 + 32) bits = 384 bits
- NCR: 64 bits
- Control logic: ~200 bits
- **Total**: ~1416 bits ≈ 177 bytes

#### 4. AAU Module (`PIMSimulator/src/AAU.h`)
**Attention Algorithm Unit**
- Supported operations: GELU, Softmax, LayerNorm, Attention Score
- Vector width: 16 elements
- Pipeline depth: 4 stages
- Peak throughput: 2.5 GOPS

**Hardware Overhead**:
- GELU unit: ~0.15 mm²
- Softmax unit: ~0.12 mm²
- LayerNorm unit: ~0.10 mm²
- Control logic: ~0.08 mm²
- **Total**: ~0.45 mm²
- **Power**: ~18.5 mW @ 800MHz, 28nm

#### 5. Gated Task Scheduler (`PIMSimulator/src/GatedTaskScheduler.h`)
**Gated Task Scheduling Unit**
- Supports sub-microsecond task switching
- Rank-level gating
- Switching latency: 1 cycle @ 800MHz = 1.25 ns

**Hardware Overhead**:
- Logic gates: ~200
- Area: ~0.00004 mm²
- Power: ~0.5 mW
- **Total latency**: < 1 μs

---

## System Integration

### ONNXim Integration

**Modified Files**:
1. `Simulator.h` / `Simulator.cc`
   - Added `_ahasd` member (AHASDIntegration instance)
   - Added `_enable_ahasd` flag
   - Integrated AHASD cycle updates (lines 214-222)
   - Added AHASD statistics output (lines 233-236)

2. `SimulationConfig.h`
   - Added AHASD configuration parameters
   - `enable_ahasd`: Master enable
   - `enable_edc`: Enable EDC
   - `enable_tvc`: Enable TVC
   - `enable_aau`: Enable AAU
   - `max_draft_length`: Maximum draft length

3. `CMakeLists.txt`
   - Added `-DENABLE_AHASD` option
   - Includes async_queue directory
   - Links AHASD modules

**Integration Flow**:
```cpp
// In Simulator::Simulator()
if (_config.enable_ahasd) {
    AHASD::AHASDConfig ahasd_config;
    ahasd_config.enable_edc = _config.enable_edc;
    ahasd_config.enable_tvc = _config.enable_tvc;
    ahasd_config.enable_aau = _config.enable_aau;
    _ahasd = std::make_unique<AHASD::AHASDIntegration>(ahasd_config);
}

// In Simulator::cycle()
if (_enable_ahasd && _ahasd) {
    if (_cycle_mask & CORE_MASK) {
        _ahasd->cycle_npu();
        _ahasd->update_npu_progress(_core_cycles);
    }
    if (_cycle_mask & DRAM_MASK) {
        _ahasd->cycle_pim();
    }
}
```

### PIMSimulator Integration

**Modified Files**:
1. `PIMRank.h` / `PIMRank.cpp`
   - Added `AAU* aau` member
   - Added `GatedTaskScheduler* gatedScheduler` member
   - Added AHASD statistics counters

2. New AHASD methods in PIMRank:
   ```cpp
   void initializeAHASD(uint32_t num_ranks);
   void updateAHASD();
   void executeAAUOperation(AAUOperation op, uint32_t num_elements);
   bool startDraftingTask(uint32_t batch_size, uint64_t estimated_cycles);
   bool startPreVerificationTask(uint32_t batch_size, uint64_t estimated_cycles);
   void printAHASDStats() const;
   ```

**Integration Flow**:
```cpp
// In PIMRank::PIMRank()
initializeAHASD(num_ranks);

// In PIMRank::update()
updateAHASD();
if (drafting_task_pending && aau->is_available()) {
    executeAAUOperation(AAUOperation::GELU, num_elements);
}

// Task switching
if (switch_to_preverification) {
    gatedScheduler->switchTask(TaskType::PRE_VERIFY);
}
```

### XiangShan Integration

**New Scala Modules**:
1. `xiangshan/ahasd/AHASDControl.scala`
   - CPU-side control logic
   - Polls EDC/TVC hardware units
   - Manages queue status
   - Handles interrupts

2. `xiangshan/ahasd/AHASDScheduler.scala`
   - Task scheduling logic
   - Dispatches tasks to PIM/NPU
   - Implements EDC-based suppression
   - Implements TVC-based pre-verification

**Memory Map**:
| Offset | Register | Access | Description |
|--------|----------|--------|-------------|
| 0x00 | CFG_ENABLE | R/W | Enable/disable AHASD |
| 0x04 | EDC_POLL_INTERVAL | R/W | EDC polling interval (cycles) |
| 0x08 | TVC_POLL_INTERVAL | R/W | TVC polling interval (cycles) |
| 0x10 | EDC_DECISION | R | Latest EDC decision |
| 0x14 | TVC_PREVERIFY_LEN | R | Pre-verification length |
| 0x18 | QUEUE_STATUS | R | Queue occupancy |

---

## Data Flow

### Drafting Flow (PIM Side)

```
┌─────────────────────────────────────────┐
│         DLM on PIM                      │
│                                         │
│  1. Generate draft tokens               │
│  2. Calculate entropy (AAU)             │
│  3. Push to unverified queue           │
│                                         │
│  ┌──────────────┐                       │
│  │     EDC      │──► Continue/Stop?     │
│  └──────────────┘                       │
│         │                               │
│         ├─► If Stop:                    │
│         │   ┌──────────────┐            │
│         │   │     TVC      │            │
│         │   └──────┬───────┘            │
│         │          │                    │
│         │          ├─► Pre-verify?      │
│         │          │                    │
│         │          ├─► Yes: Switch task │
│         │          └─► No: Wait         │
│         │                               │
│         └─► If Continue: Keep drafting  │
└─────────────────────────────────────────┘
```

### Verification Flow (NPU Side)

```
┌─────────────────────────────────────────┐
│         TLM on NPU                      │
│                                         │
│  1. Pop draft from unverified queue    │
│  2. Batch verification                  │
│  3. Calculate acceptance length         │
│  4. Push feedback to feedback queue    │
│                                         │
│  ┌──────────────┐                       │
│  │     TVC      │                       │
│  └──────┬───────┘                       │
│         │                               │
│         └─► Record cycle count          │
│         └─► Update NVCT table           │
└─────────────────────────────────────────┘
```

### Task Switching (Gated Scheduler)

```
Drafting State:
  Rank 0-3: Enabled (DLM parameters)
  Rank 4-7: Disabled
  
  ↓ (1 cycle @ 800MHz = 1.25ns)
  
Pre-verify State:
  Rank 0-3: Disabled
  Rank 4-7: Enabled (TLM parameters)
```

---

## Performance Characteristics

### Latency Breakdown

| Operation | Latency | Notes |
|-----------|---------|-------|
| EDC Decision | 1 cycle | PHT lookup + compare |
| TVC Calculation | 3-5 cycles | Moving average + division |
| AAU GELU | 8 + 2×(N/16) cycles | Base + vector ops |
| AAU Softmax | 8 + 3×(N/16) cycles | Max + exp + normalize |
| Task Switch | 1 cycle | Rank gating only |
| Queue Push/Pop | 1 cycle | Lock-free in simulation |

### Throughput

**Single NPU Core**:
- Peak: 16 TFLOPS @ 1 GHz
- Sustained: ~12 TFLOPS (75% utilization)

**Single PIM Rank**:
- Peak: 102.4 GOPS (INT8)
- Sustained: ~80 GOPS (78% utilization)

**AAU**:
- GELU: ~2.0 GOPS
- Softmax: ~1.5 GOPS
- LayerNorm: ~1.8 GOPS

### Bandwidth

**On-Chip** (within PIM):
- Internal bandwidth: 256 GB/s
- AAU access: No off-chip transfer needed

**Off-Chip** (PIM to NPU):
- LPDDR5 bandwidth: 51.2 GB/s
- Async queue overhead: < 1%

---

## Configuration

### Hardware Configuration (`configs/*.json`)

```json
{
  "hardware": {
    "npu": {
      "num_cores": 2,
      "frequency_ghz": 1.0,
      "systolic_array": "128x128",
      "spm_size_mb": 8
    },
    "pim": {
      "num_ranks": 16,
      "rank_capacity_gb": 4,
      "frequency_mhz": 800,
      "internal_bandwidth_gbps": 256,
      "external_bandwidth_gbps": 51.2
    }
  },
  "ahasd": {
    "enable_edc": true,
    "enable_tvc": true,
    "enable_aau": true,
    "max_draft_length": 16,
    "edc_h_max": 10.0,
    "tvc_freq_ratio": 0.8
  }
}
```

### Software Configuration

**XiangShan Config** (`XiangShan/ahasd_control_config.txt`):
```ini
[EDC_Control]
edc_poll_interval = 100      # CPU cycles
edc_priority = 2

[TVC_Control]
tvc_measure_interval = 50    # CPU cycles
tvc_priority = 3

[Queue_Management]
queue_poll_interval = 20     # CPU cycles
overflow_threshold = 56      # entries
```

---

## Building the Simulator

### Prerequisites

```bash
# Ubuntu 20.04+
sudo apt-get install build-essential cmake ninja-build
sudo apt-get install gcc-10 g++-10
sudo apt-get install python3 python3-pip

# Python dependencies
pip3 install numpy matplotlib
```

### Build ONNXim with AHASD

```bash
cd ONNXim
mkdir build && cd build

# Configure with AHASD enabled
cmake .. -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DENABLE_AHASD=ON \
    -DCMAKE_CXX_COMPILER=g++-10

# Build (8-16 cores recommended)
ninja -j$(nproc)

# Verify
./onnxim_main --version
# Should output: ONNXim v1.0 (AHASD enabled)
```

### Build PIMSimulator

```bash
cd PIMSimulator

# Build with SCons
scons -j$(nproc)

# Verify
./build/pim_simulator --help
```

### Build XiangShan (Optional)

```bash
cd XiangShan

# Generate Verilog with AHASD
make verilog AHASD=1

# Build emulator
make emu AHASD=1
```

---

## Running Experiments

### Quick Test (Single Configuration)

```bash
# Set environment variables
export ONNXIM_HOME=$(pwd)/ONNXim
export PIM_SIM_HOME=$(pwd)/PIMSimulator

# Run single configuration
./scripts/run_single_config.py \
    --model llama2-7b:llama2-13b \
    --algorithm adaedl \
    --config ahasd_full \
    --output results/quick_test

# Check results
cat results/quick_test/metrics.txt
```

Expected output:
```
=== AHASD Statistics ===
Throughput: 45.2 tokens/sec
Energy Efficiency: 0.193 tokens/mJ
Draft Acceptance Rate: 74.9%
EDC Accuracy: 82.3%
TVC Success Rate: 91.0%
```

### Full Experiment Suite

```bash
# Run all 60 configurations
# (3 models × 4 algorithms × 5 configs)
# Estimated time: 24-48 hours
./scripts/run_ahasd_simulation.sh

# Results will be in results/ahasd_YYYYMMDD_HHMMSS/
```

### Analyze Results

```bash
# Generate plots and tables
python3 scripts/analyze_ahasd_results.py results/ahasd_*/

# Outputs:
# - plots/throughput_comparison.png
# - plots/energy_efficiency.png
# - plots/ablation_study.png
# - plots/summary_table.csv
```

---

## Verification

### Hardware Overhead Verification

```bash
python3 scripts/validate_hardware_costs.py

# Expected output:
# Total Area: 0.4515 mm²
# LPDDR5 Die: 18 mm²
# Percentage: 2.51% < 3% ✓ VERIFIED
```

### Functional Verification

```bash
# End-to-end test
./scripts/test_e2e.sh

# Checks:
# ✓ Simulators build correctly
# ✓ AHASD modules load
# ✓ Single configuration runs
# ✓ Results format correct
```

---

## Debugging

### Enable Detailed Logging

```bash
# ONNXim
./onnxim_main --log_level trace ...

# View AHASD-specific logs
grep "AHASD" simulation.log
```

### Common Issues

1. **Build Fails**:
   ```bash
   # Clean and rebuild
   cd ONNXim/build
   rm -rf *
   cmake .. -DENABLE_AHASD=ON
   ninja
   ```

2. **Missing Dependencies**:
   ```bash
   # Install missing packages
   sudo apt-get install libboost-all-dev
   pip3 install -r requirements.txt
   ```

3. **Simulation Crashes**:
   - Check memory usage (need 64GB+ RAM)
   - Reduce batch size in config
   - Check log files for errors

---

## Performance Tuning

### Optimize Simulation Speed

```bash
# Use Release build
cmake .. -DCMAKE_BUILD_TYPE=Release

# Enable optimizations
export ONNXIM_OPT_LEVEL=3
export OMP_NUM_THREADS=$(nproc)

# Reduce logging
./onnxim_main --log_level info  # instead of debug/trace
```

### Parallel Execution

```bash
# Run multiple configurations in parallel
parallel -j 4 ./scripts/run_single_config.py ::: \
    config1 config2 config3 config4
```

---

## Architecture Diagrams

### System Overview

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    NPU      │       │     CPU     │       │     PIM     │
│             │       │             │       │             │
│  ┌───────┐  │       │  ┌───────┐  │       │  ┌───────┐  │
│  │  TLM  │  │◄──────┤  │ AHASD │  ├──────►│  │  DLM  │  │
│  │Verify │  │       │  │Control│  │       │  │ Draft │  │
│  └───────┘  │       │  └───────┘  │       │  └───────┘  │
│             │       │             │       │             │
│             │       │  ┌───────┐  │       │  ┌───────┐  │
│             │       │  │  EDC  │  │       │  │  AAU  │  │
│             │       │  │  TVC  │  │       │  └───────┘  │
│             │       │  └───────┘  │       │             │
└──────┬──────┘       └──────┬──────┘       └──────┬──────┘
       │                     │                     │
       │              ┌──────┴──────┐             │
       └──────────────┤Async Queues ├─────────────┘
                      └─────────────┘
```

---

## References

- [ONNXim Documentation](https://github.com/casys-kaist/onnxim)
- [PIMSimulator Documentation](https://github.com/SAITPublic/PIMSimulator)
- [XiangShan Documentation](https://xiangshan-doc.readthedocs.io/)
- [AHASD Paper](sample-sigconf.tex)

---

**Last Updated**: November 9, 2024  
**Version**: 2.0  
**Status**: Complete and Verified
